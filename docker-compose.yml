services:
  db:
    image: postgres:15
    container_name: gyan_db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=admin
      - POSTGRES_DB=gyan_db
    ports:
      - '5433:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7
    container_name: gyan_redis
    ports:
      - '6379:6379'

  migration:
    build:
      context: .
      dockerfile: ./services/engine_astra/Dockerfile
    container_name: gyan_migration
    command: >
      sh -c "
        /app/wait-for-postgres.sh &&
        echo 'MIGRATION: Database is up. Running Alembic migrations...' &&
        alembic upgrade head &&
        echo 'MIGRATION: Database is up to date. Exiting.'
      "
    environment:
      - DATABASE_URL=postgresql://postgres:admin@db:5432/gyan_db
      - PYTHONPATH=/app
    volumes:
      - ./services/engine_astra:/app
      - ./shared:/app/shared
    depends_on:
      - db
      - redis

  setu_api:
    build:
      context: .
      dockerfile: ./services/api_setu/Dockerfile
    container_name: gyan_setu_api
    ports:
      - '8000:8000'
    volumes:
      - ./services/api_setu:/app
      - ./shared:/app/shared
    environment:
      - DATABASE_URL=postgresql://postgres:admin@db:5432/gyan_db
      - REDIS_URL=redis://redis:6379/0
      - PYTHONPATH=/app
    depends_on:
      db:
        condition: service_started
      migration:
        condition: service_completed_successfully

  astra_brain:
    build:
      context: .
      dockerfile: ./services/engine_astra/Dockerfile
    container_name: gyan_astra_brain
    volumes:
      - ./services/engine_astra:/app
      - ./saved_models:/app/saved_models
      - ./shared:/app/shared
    environment:
      - DATABASE_URL=postgresql://postgres:admin@db:5432/gyan_db
      - REDIS_URL=redis://redis:6379/0
      - PYTHONPATH=/app
    dns:
      - 8.8.8.8
      - 8.8.4.4
    depends_on:
      db:
        condition: service_started
      migration:
        condition: service_completed_successfully
      ollama:
        condition: service_started

  chakra_scheduler:
    build:
      context: .
      dockerfile: ./services/worker_chakra/Dockerfile
    container_name: gyan_chakra_scheduler
    volumes:
      - ./services/worker_chakra:/app
    environment:
      - DATABASE_URL=postgresql://postgres:admin@db:5432/gyan_db
      - REDIS_URL=redis://redis:6379/0
      - PYTHONPATH=/app
    depends_on:
      db:
        condition: service_started
      migration:
        condition: service_completed_successfully

  darpan_ui:
    build:
      context: ./services/frontend_darpan
      dockerfile: Dockerfile
    container_name: gyan_darpan_ui
    ports:
      - '8501:8501'
    volumes:
      - ./services/frontend_darpan:/app
    environment:
      - PYTHONPATH=/app
    depends_on:
      - setu_api

  sutra_automation:
    image: n8nio/n8n
    container_name: gyan_sutra_automation
    ports:
      - '5678:5678'
    volumes:
      - ./sutra_data:/home/node/.n8n
    environment:
      - GENERIC_TIMEZONE=Asia/Kolkata

  ollama:
    image: ollama/ollama:latest
    container_name: gyan_ollama
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "11434:11434"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]

volumes:
  postgres_data:
  ollama_data:
