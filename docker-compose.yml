version: '3.9'

services:
  # --- 1. CORE INFRASTRUCTURE ---
  db:
    image: postgres:15
    container_name: gyan_db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=admin
      - POSTGRES_DB=gyan_db
    ports:
      - '5433:5432' 
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7
    container_name: gyan_redis
    ports:
      - '6379:6379'

  # --- 2. THE NEW MIGRATION SERVICE ---
  migration:
    build:
      context: . # <-- FIX: Context is the root
      dockerfile: ./services/engine_astra/Dockerfile # Point to the Dockerfile
    container_name: gyan_migration
    command: >
      sh -c "
        echo 'MIGRATION: Waiting for database...'
        /app/wait-for-postgres.sh
        echo 'MIGRATION: Database is up. Running schema migration...'
        python -c 'from database import create_db_and_tables; create_db_and_tables()'
        echo 'MIGRATION: Schema updated. Exiting.'
      "
    environment:
      - DATABASE_URL=postgresql://postgres:admin@db:5432/gyan_db
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis

  # --- 3. PYTHON APPLICATION SERVICES ---
  setu_api:
    build:
      context: . # <-- FIX
      dockerfile: ./services/api_setu/Dockerfile # <-- FIX
    container_name: gyan_setu_api
    ports:
      - '8000:8000'
    volumes:
      - ./services/api_setu:/app
    environment:
      - DATABASE_URL=postgresql://postgres:admin@db:5432/gyan_db
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      db:
        condition: service_started
      migration:
        condition: service_completed_successfully

  astra_brain:
    build:
      context: . # <-- FIX
      dockerfile: ./services/engine_astra/Dockerfile # <-- FIX
    container_name: gyan_astra_brain
    volumes:
      - ./services/engine_astra:/app
      - ./saved_models:/app/saved_models
    environment:
      - DATABASE_URL=postgresql://postgres:admin@db:5432/gyan_db
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      db:
        condition: service_started
      migration:
        condition: service_completed_successfully

  chakra_scheduler:
    build:
      context: . # <-- FIX
      dockerfile: ./services/worker_chakra/Dockerfile # <-- FIX
    container_name: gyan_chakra_scheduler
    volumes:
      - ./services/worker_chakra:/app
    environment:
      - DATABASE_URL=postgresql://postgres:admin@db:5432/gyan_db
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      db:
        condition: service_started
      migration:
        condition: service_completed_successfully

  darpan_ui:
    build:
      context: . # <-- FIX
      dockerfile: ./services/frontend_darpan/Dockerfile # <-- FIX
    container_name: gyan_darpan_ui
    ports:
      - '8501:8501'
    volumes:
      - ./services/frontend_darpan:/app
    depends_on:
      - setu_api

  sutra_automation:
    image: n8nio/n8n
    container_name: gyan_sutra_automation
    ports:
      - '5678:5678'
    volumes:
      - ./sutra_data:/home/node/.n8n
    environment:
      - GENERIC_TIMEZONE=Asia/Kolkata

volumes:
  postgres_data: